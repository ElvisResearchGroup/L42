mut JServer j
mut Player player
mut Map.Env env
var Size pings
class method mut This #$of()=(
  p=Player()
  This(
    j=JServer.#$of(),
    player=p
    env=Map.Env.#$of(player=p)
    pings=0Size
    )
  )
@JServer.Handler mut method Void reset(S msg)=
  this.#player().pos(\(x=20\,y=75\))

@JServer.Handler mut method Void typed(S msg)=(
  if msg==S.nl() (
    text=this.#player().text()
    x=this.#player().pos().x()
    y=this.#player().pos().y()
    this.#env().#es().#add(right=Bullet(text=text,x=x,y=y))
    )
  this.#player().input(msg=msg)
  )
@JServer.Handler mut method Void pressed(S msg)=
  this.#player().input(msg=msg,pressed=Bool.true())
@JServer.Handler mut method Void released(S msg)=
  this.#player().input(msg=msg,pressed=Bool.false())

@JServer.Handler mut method Void ping(S msg)=(
  this.#env().clearRemoveQueue()
  this.pings(\pings+1\)
  es=this.#env().#es()
  newRat=(this.pings()/360Size)*360Size==this.pings()
  if newRat (
    xr=Double.from(num=this.#env().#r().nextInRange(start=0\,end=500\).toNum(denominator=1Size))
    yr=Double.from(num=this.#env().#r().nextInRange(start=0\,end=500\).toNum(denominator=1Size))
    r=Rat(text=S"Num%(this.pings()/360Size)",x=xr,y=yr)
    es.#add(right=r)
    )
  var res=S""
  for mut e in es (
    e.ping(this.#env())
    res++=e.paint()++S.nl() 
    )
  this.#j().submitEvent(key='Example.RefreshEntities, id=S"base", msg=res)
  whoops JServer.Fail
  )