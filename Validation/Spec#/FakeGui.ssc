using System;
using System.Collections.Generic;
using System.Text;
using Microsoft.Contracts;

[Immutable] internal partial class Gui
{
	internal readonly string id;

	internal void display(string title, int x, int y, Widget body, string[] events)
	{
		this.open(title, "<div id='Top'></div>", x, y);
		this.draw(body);
		this.dispatch(body, events);
		// TODO: this.dispatch(body, this.events);
	}

	void draw(Widget that)
	{
		this.set_("<div id='Top' style='position: relative; height: 750px; width: 750px; border: solid black 2px;'>" + this.format(that) + "</div>", "Top");
	}

	string JsEscape(string that) 
	{
		return that.Replace("\\", @"\\").Replace("\"", @"\""").Replace("\'", @"\'").Replace("\n", @"\n");
	}

	void set_(string that, string id)
	{
		string qid = "'" + JsEscape(id) + "'";
		string qText = "'" + JsEscape(that) + "'";
		string cmd = @"var oldElem = document.getElementById(" + qid + @"');
			oldElem.innerHTML = " + qText + @"';
			var parentElem = oldElem.parentNode;
			var innerElem; 
			while (innerElem = oldElem.firstChild) {
				parentElem.insertBefore(innerElem, oldElem); 
			}
			parentElem.removeChild(oldElem);";

        this.executeJs(cmd);
	}

	[Pure] string formatChildren(Widget that)
	{
		StringBuilder children = new StringBuilder();
		for (int i = 0; i < that.children.Count; i++) 
			children.Append(this.format(that.children[i]));
		return children.ToString();
	}

	[Pure] string format(Widget that) {
		Button? b = that as Button;
		if (b != null) return formatB(b);
		return formatW(that);
	}
	// This horrible looking stream of functions is just to make verification faster compared to putting it all in one function.
	[Pure] string formatW(Widget that)     { return formatW1("<div id='" + that.id + "' onclick=\"event42('" + that.id + "::Pressed::more')\" style='position: absolute;", that); }
	[Pure] string formatW1(string res, Widget that) { return formatW2(res + "left: " + that.left + "px;",               that); }
	[Pure] string formatW2(string res, Widget that) { return formatW3(res + "top: " + that.top + "px;",                 that); }
	[Pure] string formatW3(string res, Widget that) { return formatW4(res + "height: " + that.height + "px;",           that); }
	[Pure] string formatW4(string res, Widget that) { return formatW5(res + "width: " + that.width + "px;",             that); }
	[Pure] string formatW5(string res, Widget that) { return formatW6(res + "background-color: " + that.colour + ";'>", that); }
	[Pure] string formatW6(string res, Widget that) { return res + "<div style='position: relative;'>" + formatChildren(that) + "</div></div>"; }

	[Pure] string formatB(Button that)     { return formatB1("<button id='" + that.id + "' onclick=\"event42('" + that.id + "::Pressed::more')\" style='position: absolute;", that); }
	[Pure] string formatB1(string res, Widget that) { return formatB2(res + "left: " + that.left + "px;",               that); }
	[Pure] string formatB2(string res, Widget that) { return formatB3(res + "top: " + that.top + "px;",                 that); }
	[Pure] string formatB3(string res, Widget that) { return formatB4(res + "height: " + that.height + "px;",           that); }
	[Pure] string formatB4(string res, Widget that) { return res + "width: " + that.width + "px;></button>"; }

	void open(string title, string body, int x, int y) { this.open(HtmlHeader() + "<title>" + title + "</title></head><body>" + body + "</body></html>", x, y); }

	string HtmlHeader() { return "<!DOCTYPE html><html><head><meta http-equiv='content-class' content='text/html; charset=UTF-8'>"; }

	void dispatch(Widget body, IEnumerable<string> events)
	{
		foreach (string event_ in events) {
			if (event_ == "EXIT") return;
			body.dispatch(new Event(event_));
			this.draw(body);
		}
	}

	void open(string html, int x, int y)  /*mut*/ 
	{
		//Debug("GuiPlugin.open(wName: {0}, html: {1}, x: {2}, y: {3})", this.id, html, x, y);
		// TODO: PLUGIN
	}

	string executeJs(string that) /*mut*/ 
	{
		//Debug("GuiPlugin.executeJs(wName: {0}, command: {1})", this.id, that);
		// TODO: PLUGIN
		return "";
	}

	internal Gui(string id) { this.id = id; }
}